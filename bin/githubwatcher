#!/usr/bin/ruby
ENV['BUNDLE_GEMFILE'] = File.expand_path('../../Gemfile', __FILE__)

require 'rubygems' unless defined?(Gem)
require 'bundler/setup'
require 'forever'
require 'githubwatcher'

while ARGV.size > 0
  case arg = ARGV.shift
    when "configure"
      editor = `which mate`.chomp! || `which vim`.chomp!
      puts "Im unable to find an editor, open manually ~/.githubwatcher/repos.yaml" and exit unless editor
      system editor, File.expand_path('~/.githubwatcher/repos.yaml') and exit
    when "reset"
      system "rm -rf ~/.githubwatcher"
  end
end

Forever.run do
  # Our working directory, here we store pids/logs and obviously our list of repo to watch
  dir File.expand_path('~/.githubwatcher')

  on_error do |e|
    unless (@_errors ||= []).include?(e.message)
      Githubwatcher.notify("Error!", e.message, false)
      @_errors << e.message
    end
  end

  on_ready do
    Githubwatcher.setup
    Githubwatcher.notify("GitHub Watcher", "was started...", false)
  end

  on_exit do
    Githubwatcher.notify("GitHub Watcher", "was stopped...", false)
  end

  every 5.seconds do
    Githubwatcher.run
  end
end
