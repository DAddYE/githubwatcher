#!/usr/bin/ruby
$: << File.expand_path('../../lib', __FILE__) # For unknow reason bundler don't always add this path
require 'rubygems' unless defined?(Gem)
require 'forever'
require 'bundler/setup'
require 'githubwatcher'

if ARGV.any? { |cmd| cmd =~ /config(?:ure)?/i }
  editor = `which mate`.chomp! || `which vim`.chomp!
  puts "Im unable to find an editor, open manually ~/.githubwatcher/repos.yaml" and exit unless editor
  system editor, File.expand_path('~/.githubwatcher/repos.yaml') and exit
end

Forever.run do
  # Our working directory, here we store pids/logs and obviously our list of repo to watch
  dir File.expand_path('~/.githubwatcher')

  on_error do |e|
    Githubwatcher.notify("Error!", e.message)
  end

  on_ready do
    Githubwatcher.start!
  end

  every 60.seconds do
    puts "Restarting, to clean up our memory"
    system Gem.ruby, __FILE__
  end
end